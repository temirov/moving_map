<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USA Moving Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-gesture-handling/dist/leaflet-gesture-handling.min.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
        /* Custom styling for the county labels */
        .county-label {
            font-size: 12px;
            color: black;
            background: white;
            border-radius: 3px;
            padding: 2px;
            border: 1px solid rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        /* Custom styling for the school areas labels */
        .school-label {
            font-size: 12px;
            color: black;
            background: white;
            border-radius: 3px;
            padding: 2px;
            border: 1px solid rgba(0, 0, 0, 0.5);
            text-align: center;
        }
    </style>
</head>
<body>
<div id="map" style="width: 100%; height: 600px;"></div>

<script>
    // Initialize the map with gesture handling
    var map = L.map('map', {
        attributionControl: false,  // Disable default attribution control
        gestureHandling: true       // Enable gesture handling for better trackpad support
    }).fitBounds([
        [24.396308, -125.0],  // Southwest coordinates (bottom-left corner)
        [49.384358, -66.93457]  // Northeast coordinates (top-right corner)
    ]);

    // Add CartoDB Positron (With Labels) Tile Layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
    }).addTo(map);

    // Load the GeoJSON data for U.S. states
    fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
        .then(response => response.json())
        .then(statesData => {
            // Add state borders to the map
            L.geoJSON(statesData, {
                style: function(feature) {
                    return {
                        color: '#1E90FF',
                        weight: 2,
                        opacity: 0.8
                    };
                }
            }).addTo(map);
        });

    // Load the GeoJSON data for U.S. counties
    let countiesLayer;
    fetch('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json')
        .then(response => response.json())
        .then(countiesData => {
            countiesLayer = L.geoJSON(countiesData, {
                style: function(feature) {
                    return {
                        color: '#FF4500',
                        weight: 1,
                        opacity: 0.6
                    };
                }
            }).addTo(map);

            // Show labels for counties in view and at an appropriate zoom level
            map.on('moveend', function() {
                updateLabels();
            });

            function updateLabels() {
                // Clear existing labels
                countiesLayer.eachLayer(function(layer) {
                    if (layer._tooltip) {
                        layer.unbindTooltip();
                    }
                });

                // Add labels only to visible counties
                const currentBounds = map.getBounds();
                const minZoomLevel = 8;  // Adjust the zoom level threshold as needed

                if (map.getZoom() >= minZoomLevel) {
                    countiesLayer.eachLayer(function(layer) {
                        const bounds = layer.getBounds();
                        if (currentBounds.intersects(bounds)) {
                            const name = layer.feature.properties.NAME;
                            if (name) {
                                layer.bindTooltip(name, {
                                    permanent: true,
                                    direction: 'center',
                                    className: 'county-label'
                                }).openTooltip();
                            }
                        }
                    });
                }
            }

            updateLabels(); // Initial label display
        });

    // Custom Locate Control with County Zooming
    L.control.locate({
        position: 'topleft',
        flyTo: false, // Disable default flyTo behavior
        icon: 'fa fa-location-arrow',
        iconLoading: 'fa fa-spinner fa-spin',
        showPopup: false,
        locateOptions: {
            maxZoom: 10,
            enableHighAccuracy: true
        },
        onLocationFound: function(e) {
            var userLatLng = e.latlng;

            // Find the county the user is in by checking their position against the county boundaries
            let countyFound = false;
            countiesLayer.eachLayer(function(layer) {
                var bounds = layer.getBounds();
                if (bounds.contains(userLatLng)) {
                    // Zoom to the found county
                    map.fitBounds(bounds);
                    countyFound = true;
                }
            });

            if (!countyFound) {
                console.log('No county found for the user location.');
            }
        }
    }).addTo(map);

    // Load the TopoJSON data for school boundaries
    fetch('data/school_boundaries.topojson')
        .then(response => response.json())
        .then(topoData => {
            // Convert TopoJSON to GeoJSON
            const schoolGeoJSON = topojson.feature(topoData, topoData.objects['school_boundaries']);

            // Add school boundaries to the map
            L.geoJSON(schoolGeoJSON, {
                style: function(feature) {
                    return {
                        color: '#32CD32',  // Lime green color for school boundaries
                        weight: 2,
                        opacity: 0.8
                    };
                },
                onEachFeature: function (feature, layer) {
                    if (feature.properties && feature.properties.NAME) {
                        // Use mouseover and mouseout to show/hide popups
                        layer.on('mouseover', function () {
                            layer.bindPopup(`<strong>${feature.properties.NAME}</strong>`).openPopup();
                        });
                        layer.on('mouseout', function () {
                            layer.closePopup();
                        });
                    }
                }
            }).addTo(map);
        });

    let schoolLayer;

    function updateSchoolMarkers() {
        const zoomLevel = map.getZoom();
        if (zoomLevel >= 12) {  // Set the desired zoom level threshold
            if (!schoolLayer) {
                // Load the GeoJSON data for public school locations
                fetch('data/public-school-locations-08-24.geojson')
                    .then(response => response.json())
                    .then(schoolData => {
                        schoolLayer = L.geoJSON(schoolData, {
                            pointToLayer: function(feature, latlng) {
                                return L.marker(latlng);
                            },
                            onEachFeature: function (feature, layer) {
                                // Add a popup showing the school name
                                if (feature.properties && feature.properties.NAME) {
                                    layer.bindPopup(
                                        `<strong>${feature.properties.NAME}</strong><br>` +
                                        `${feature.properties.STREET}<br>` +
                                        `${feature.properties.CITY}, ${feature.properties.STATE} ${feature.properties.ZIP}`
                                    );
                                }
                            }
                        }).addTo(map);
                    });
            } else {
                map.addLayer(schoolLayer);
            }
        } else if (schoolLayer) {
            map.removeLayer(schoolLayer);
        }
    }

    map.on('zoomend', updateSchoolMarkers);

    updateSchoolMarkers(); // Initial call to load schools based on initial zoom level

</script>
</body>
</html>
